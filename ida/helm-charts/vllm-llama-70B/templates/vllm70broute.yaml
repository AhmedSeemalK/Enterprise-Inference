# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

apiVersion: apisix.apache.org/v2
kind: ApisixRoute
metadata:
  name: vllm70b-authenticated-endpoints
  namespace: {{ .Values.vllm70B.namespace }}
spec:
  http:
  - name: vllmllama70b-query
    match:
      hosts:
      - {{ .Values.vllm70B.hostname }}
      paths:
      - {{ .Values.vllm70B.query_api.path }}
    backends:
    - serviceName: {{ .Values.vllm70B.query_api.backend_service }}
      servicePort: {{ .Values.vllm70B.query_api.service_port }}
    plugins:
    - name: openid-connect
      enable: true
      config:
        client_id: {{ .Values.oidc.client_id }}
        client_secret: {{ .Values.oidc.client_secret }}
        discovery: {{ .Values.oidc.discovery }}
        introspection_endpoint: {{ .Values.oidc.introspection_endpoint }}
        introspection_endpoint_auth_method: client_secret_basic
        scope: openid profile email
        bearer_only: true
        realm: master
    - name: proxy-rewrite
      enable: true
      config:
        regex_uri: ["^/Meta-Llama-3.1-70B-Instruct/(.*)", "/$1"] # This will capture everything after /tgi/ and use it as the new path
        headers:
          Content-Type: application/json